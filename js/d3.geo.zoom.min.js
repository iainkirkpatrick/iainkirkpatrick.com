/* Copyright 2015, Jason Davies. All rights reserved. */!function(){function t(t,n,o){var a=t.translate(),r=Math.atan2(n[1]-a[1],n[0]-a[0])-Math.atan2(o[1]-a[1],o[0]-a[0]);return[Math.cos(r/2),0,0,Math.sin(r/2)]}function n(t,n){var o=t.invert(n);return o&&isFinite(o[0])&&isFinite(o[1])&&u(o)}function o(t){var n=.5*t[0]*f,o=.5*t[1]*f,a=.5*t[2]*f,r=Math.sin(n),e=Math.cos(n),i=Math.sin(o),u=Math.cos(o),s=Math.sin(a),c=Math.cos(a);return[e*u*c+r*i*s,r*u*c-e*i*s,e*i*c+r*u*s,e*u*s-r*i*c]}function a(t,n){var o=t[0],a=t[1],r=t[2],e=t[3],i=n[0],u=n[1],s=n[2],c=n[3];return[o*i-a*u-r*s-e*c,o*u+a*i+r*c-e*s,o*s-a*c+r*i+e*u,o*c+a*s-r*u+e*i]}function r(t,n){if(t&&n){var o=c(t,n),a=Math.sqrt(s(o,o)),r=.5*Math.acos(Math.max(-1,Math.min(1,s(t,n)))),e=Math.sin(r)/a;return a&&[Math.cos(r),o[2]*e,-o[1]*e,o[0]*e]}}function e(t,n){var o=Math.max(-1,Math.min(1,s(t,n))),a=0>o?-1:1,r=Math.acos(a*o),e=Math.sin(r);return e?function(o){var i=a*Math.sin((1-o)*r)/e,u=Math.sin(o*r)/e;return[t[0]*i+n[0]*u,t[1]*i+n[1]*u,t[2]*i+n[2]*u,t[3]*i+n[3]*u]}:function(){return t}}function i(t){return[Math.atan2(2*(t[0]*t[1]+t[2]*t[3]),1-2*(t[1]*t[1]+t[2]*t[2]))*m,Math.asin(Math.max(-1,Math.min(1,2*(t[0]*t[2]-t[3]*t[1]))))*m,Math.atan2(2*(t[0]*t[3]+t[1]*t[2]),1-2*(t[2]*t[2]+t[3]*t[3]))*m]}function u(t){var n=t[0]*f,o=t[1]*f,a=Math.cos(o);return[a*Math.cos(n),a*Math.sin(n),Math.sin(o)]}function s(t,n){for(var o=0,a=t.length,r=0;a>o;++o)r+=t[o]*n[o];return r}function c(t,n){return[t[1]*n[2]-t[2]*n[1],t[2]*n[0]-t[0]*n[2],t[0]*n[1]-t[1]*n[0]]}function h(t){for(var n=0,o=arguments.length,a=[];++n<o;)a.push(arguments[n]);var r=d3.dispatch.apply(null,a);return r.of=function(n,o){return function(a){try{var e=a.sourceEvent=d3.event;a.target=t,d3.event=a,r[a.type].apply(n,o)}finally{d3.event=e}}},r}var f=Math.PI/180,m=180/Math.PI;d3.geo.zoom=function(){function s(t){l++||t({type:"zoomstart"})}function c(t){t({type:"zoom"})}function f(t){--l||t({type:"zoomend"})}var m,M,v,l=0,d=h(z,"zoomstart","zoom","zoomend"),z=d3.behavior.zoom().on("zoomstart",function(){var e=d3.mouse(this),u=o(m.rotate()),h=n(m,e);h&&(v=h),_.call(z,"zoom",function(){m.scale(g.k=d3.event.scale);var o=d3.mouse(this),s=r(v,n(m,o));m.rotate(g.r=i(u=s?a(u,s):a(t(m,e,o),u))),e=o,c(d.of(this,arguments))}),s(d.of(this,arguments))}).on("zoomend",function(){_.call(z,"zoom",null),f(d.of(this,arguments))}),_=z.on,g={r:[0,0,0],k:1};return z.rotateTo=function(t){var n=r(u(t),u([-g.r[0],-g.r[1]]));return i(a(o(g.r),n))},z.projection=function(t){return arguments.length?(m=t,g={r:m.rotate(),k:m.scale()},z.scale(g.k)):m},z.duration=function(t){return arguments.length?(M=t,z):M},z.event=function(t){t.each(function(){var t=d3.select(this),n=d.of(this,arguments),a=g,r=d3.transition(t);r!==t?r.each("start.zoom",function(){this.__geo_zoom__&&(g=this.__geo_zoom__),m.rotate(g.r).scale(g.k),s(n)}).tween("zoom:zoom",function(){var t=z.size()[0],u=e(o(g.r),o(a.r)),s=d3.geo.distance(g.r,a.r),h=d3.interpolateZoom([0,0,t/g.k],[s,0,t/a.k]);return M&&r.duration(M(.001*h.duration)),function(o){var a=h(o);this.__geo_zoom__=g={r:i(u(a[0]/s)),k:t/a[2]},m.rotate(g.r).scale(g.k),z.scale(g.k),c(n)}}).each("end.zoom",function(){f(n)}):(this.__geo_zoom__=g,s(n),c(n),f(n))})},d3.rebind(z,d,"on")}}();
